<!-- heatmap.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>PiCam Lite | Heatmap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="style.css" rel="stylesheet">
  <script defer src="main.js"></script>
</head>
<body data-page="heatmap">
  <header class="site-header">
    <h1>Heatmap</h1>
    <p class="tagline">Motion intensity per hour today</p>
  </header>

  <nav class="site-nav" aria-label="Primary">
    <a href="index.html" data-link="home">Home</a>
    <a href="live.html" data-link="live">Live</a>
    <a href="photos.html" data-link="photos">Photos</a>
    <a href="replays.html" data-link="replays">Replays</a>
    <a href="heatmap.html" data-link="heatmap">Heatmap</a>
  </nav>

  <main id="heatmap-main" class="container">
    <!-- Stats Summary Panel -->
    <div class="stats-panel">
      <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <div class="stat-value" id="total-detections">‚Äî</div>
        <div class="stat-label">Total Detections</div>
      </div>
      
      <div class="stat-card alert-stat">
        <div class="stat-icon">üö®</div>
        <div class="stat-value" id="alert-count">‚Äî</div>
        <div class="stat-label">After-Hours Alerts</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">üïê</div>
        <div class="stat-value" id="most-recent">‚Äî</div>
        <div class="stat-label">Most Recent Alert</div>
      </div>
    </div>

    <section>
      <h2>Activity Heatmap (Last 7 Days)</h2>
      <div class="heatmap-wrapper">
        <div class="heatmap-day-labels">
          <span>Mon</span>
          <span>Tue</span>
          <span>Wed</span>
          <span>Thu</span>
          <span>Fri</span>
          <span>Sat</span>
          <span>Sun</span>
        </div>
        <div id="heatmap" class="heatmap" role="img" aria-label="Hourly motion heatmap"></div>
      </div>
      <div class="heatmap-axis">
        <span>12AM</span><span>3AM</span><span>6AM</span><span>9AM</span><span>12PM</span><span>3PM</span><span>6PM</span><span>9PM</span>
      </div>
    </section>

    <div class="legend-panel">
      <div class="legend-item">
        <div class="legend-color normal-hours"></div>
        <span>Normal Hours (6AM-11PM)</span>
      </div>
      <div class="legend-item">
        <div class="legend-color after-hours"></div>
        <span>After Hours (12AM-5AM) üö®</span>
      </div>
    </div>

    <!-- Thumbnail Gallery (shown when clicking a cell) -->
    <div id="thumbnail-gallery" class="thumbnail-gallery hidden">
      <div class="gallery-header">
        <h3 id="gallery-title">Activity Details</h3>
        <button class="close-gallery" onclick="closeGallery()">‚úï</button>
      </div>
      <div id="gallery-content" class="gallery-content"></div>
    </div>
  </main>

  <script>
    const AFTER_HOURS_START = 0;  // 12AM
    const AFTER_HOURS_END = 5;    // 5AM

    let heatmapData = null;
    let photosData = [];

    // Fetch heatmap and photos data
    async function loadData() {
      try {
        // Fetch heatmap data (last 7 days)
        const heatmapRes = await fetch('/api/heatmap?days=7');
        heatmapData = await heatmapRes.json();
        
        // Fetch photos for thumbnail display
        const photosRes = await fetch('/api/photos');
        photosData = await photosRes.json();
        
        renderHeatmap();
        updateStats();
      } catch (err) {
        console.error('Failed to load data:', err);
      }
    }

    function renderHeatmap() {
      if (!heatmapData) return;
      
      const container = document.getElementById('heatmap');
      container.innerHTML = '';
      
      // Calculate max count for intensity scaling
      let maxCount = 1;
      Object.values(heatmapData).forEach(dayData => {
        Object.values(dayData).forEach(count => {
          maxCount = Math.max(maxCount, count);
        });
      });
      
      // Render 7 days √ó 24 hours = 168 cells
      for (let day = 0; day < 7; day++) {
        for (let hour = 0; hour < 24; hour++) {
          const count = heatmapData[day]?.[hour] || 0;
          const intensity = Math.min(count / maxCount, 1);
          const isAfterHours = hour >= AFTER_HOURS_START && hour < AFTER_HOURS_END;
          
          const cell = document.createElement('div');
          cell.className = 'heat-cell';
          cell.dataset.day = day;
          cell.dataset.hour = hour;
          cell.dataset.count = count;
          cell.title = `${getDayName(day)} ${hour}:00 - ${count} detections`;
          
          // Apply color based on time period
          if (isAfterHours) {
            // Red gradient for after-hours
            const r = Math.floor(255 * (0.4 + intensity * 0.6));
            const g = Math.floor(82 * (1 - intensity * 0.5));
            const b = Math.floor(82 * (1 - intensity * 0.5));
            cell.style.background = `rgb(${r}, ${g}, ${b})`;
            
            if (count > 0) {
              cell.style.boxShadow = `
                inset 0 0 0 1px rgba(198, 40, 40, 0.4),
                0 0 ${8 + intensity * 12}px rgba(255, 82, 82, ${intensity * 0.6})
              `;
            }
          } else {
            // Blue gradient for normal hours
            const r = Math.floor(33 * (0.5 + intensity * 0.5));
            const g = Math.floor(150 * (0.4 + intensity * 0.6));
            const b = Math.floor(243 * (0.3 + intensity * 0.7));
            cell.style.background = `rgb(${r}, ${g}, ${b})`;
            
            if (count > 0) {
              cell.style.boxShadow = `inset 0 0 0 1px rgba(33, 150, 243, 0.3)`;
            }
          }
          
          // Click handler to show photos
          cell.addEventListener('click', () => showPhotosForCell(day, hour, count, isAfterHours));
          
          container.appendChild(cell);
        }
      }
    }

    function updateStats() {
      if (!heatmapData || !photosData) return;
      
      // Calculate total detections
      let total = 0;
      let afterHoursCount = 0;
      
      Object.entries(heatmapData).forEach(([day, hours]) => {
        Object.entries(hours).forEach(([hour, count]) => {
          total += count;
          const h = parseInt(hour);
          if (h >= AFTER_HOURS_START && h < AFTER_HOURS_END) {
            afterHoursCount += count;
          }
        });
      });
      
      document.getElementById('total-detections').textContent = total.toLocaleString();
      document.getElementById('alert-count').textContent = afterHoursCount.toLocaleString();
      
      // Find most recent after-hours photo
      const afterHoursPhotos = photosData.filter(p => {
        const hour = new Date(p.timestamp * 1000).getHours();
        return hour >= AFTER_HOURS_START && hour < AFTER_HOURS_END;
      });
      
      if (afterHoursPhotos.length > 0) {
        const mostRecent = afterHoursPhotos[0]; // Assuming sorted by newest first
        const time = new Date(mostRecent.timestamp * 1000).toLocaleTimeString('en-US', {
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });
        document.getElementById('most-recent').textContent = time;
      } else {
        document.getElementById('most-recent').textContent = 'None';
      }
    }

    function showPhotosForCell(day, hour, count, isAfterHours) {
      if (count === 0) return;
      
      const gallery = document.getElementById('thumbnail-gallery');
      const content = document.getElementById('gallery-content');
      const title = document.getElementById('gallery-title');
      
      title.textContent = `${getDayName(day)} at ${hour}:00 ${isAfterHours ? 'üö® After Hours' : ''}`;
      
      // Filter photos for this specific day/hour
      const filteredPhotos = photosData.filter(p => {
        const date = new Date(p.timestamp * 1000);
        const photoDay = date.getDay(); // 0=Sun, 1=Mon, etc
        const photoHour = date.getHours();
        
        // Convert our day index (0=Mon) to Date's day (1=Mon)
        const adjustedDay = (day + 1) % 7;
        return photoDay === adjustedDay && photoHour === hour;
      });
      
      content.innerHTML = '';
      
      if (filteredPhotos.length === 0) {
        content.innerHTML = '<p class="muted">No photos captured during this period.</p>';
      } else {
        filteredPhotos.forEach(photo => {
          const photoHour = new Date(photo.timestamp * 1000).getHours();
          const isPhotoAfterHours = photoHour >= AFTER_HOURS_START && photoHour < AFTER_HOURS_END;
          
          const card = document.createElement('div');
          card.className = `photo-card ${isPhotoAfterHours ? 'after-hours' : ''}`;
          card.innerHTML = `
            <img src="/data/photos/${photo.filename}" alt="Detection photo" loading="lazy">
            ${isPhotoAfterHours ? '<span class="alert-badge">üö® Alert</span>' : ''}
            <div class="photo-time">${formatTime(photo.timestamp)}</div>
          `;
          content.appendChild(card);
        });
      }
      
      gallery.classList.remove('hidden');
    }

    function closeGallery() {
      document.getElementById('thumbnail-gallery').classList.add('hidden');
    }

    function getDayName(day) {
      const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      return days[day];
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp * 1000);
      return date.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
      });
    }

    // Initialize on load
    loadData();
    
    // Update year in footer
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>

  <footer class="site-footer">
    <small>&copy; <span id="year"></span> PiCam Lite</small>
  </footer>
</body>
</html>
